<app-layout name="Media">
  <div class="row">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
          <div>
            <h4 class="mb-1 text-uppercase">Thư viện Media</h4>
            <p class="text-muted mb-0">
              Quản lý toàn bộ hình ảnh sản phẩm. Tải ảnh lên AWS S3, lưu metadata và xoá khi không cần thiết.
            </p>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <label class="btn btn-primary mb-0">
              <i class="bi bi-cloud-arrow-up me-1"></i> Upload ảnh
              <input id="mediaUploadInput" type="file" multiple accept="image/*" class="d-none"
                onchange="angular.element(this).scope().handleFileChange(this.files)">
            </label>
            <button class="btn btn-outline-secondary" ng-click="loadImages()" ng-disabled="isLoading">
              <i class="bi bi-arrow-repeat me-1"></i> Làm mới
            </button>
            <button class="btn btn-outline-primary"
              ng-class="{'active': selectionMode}"
              ng-click="toggleSelectionMode()">
              <span ng-if="!selectionMode"><i class="bi bi-check2-square me-1"></i> Chọn nhiều</span>
              <span ng-if="selectionMode"><i class="bi bi-x-circle me-1"></i> Thoát chọn</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row align-items-center mb-4">
    <div class="col-md-6 mb-2 mb-md-0">
      <input type="search" class="form-control" placeholder="Tìm kiếm theo tên hoặc key..." ng-model="searchTerm">
    </div>
    <div class="col-md-6 text-md-end">
      <span class="text-muted">Tổng: {{images.length}} ảnh</span>
    </div>
  </div>

  <div class="alert alert-info d-flex align-items-center justify-content-between"
    ng-if="selectionMode">
    <div>
      <strong>{{getSelectedCount()}}</strong> ảnh đã chọn.
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-secondary" ng-click="selectAllVisible()">Chọn tất cả</button>
      <button class="btn btn-sm btn-outline-secondary" ng-click="clearSelection()">Bỏ chọn</button>
      <button class="btn btn-sm btn-danger" ng-click="deleteSelected()" ng-disabled="isBulkDeleting || getSelectedCount() === 0">
        <span ng-if="!isBulkDeleting">Xoá đã chọn</span>
        <span ng-if="isBulkDeleting">Đang xoá...</span>
      </button>
    </div>
  </div>

  <div class="text-center my-4" ng-if="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Đang tải...</span>
    </div>
  </div>

  <div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-25 d-flex align-items-center justify-content-center"
    ng-if="isUploading" style="z-index: 1050;">
    <div class="text-center bg-white p-4 rounded shadow-lg">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Đang tải lên...</span>
      </div>
      <p class="mb-0 fw-semibold">Đang tải ảnh lên...</p>
    </div>
  </div>

  <div class="row g-3" ng-if="images.length > 0">
    <div class="col-sm-6 col-md-4 col-lg-3" ng-repeat="item in images | filter:searchImages">
      <div class="card h-100 shadow-sm position-relative">
        <div class="position-absolute p-2" ng-if="selectionMode"
          style="z-index: 3;">
          <input class="form-check-input" type="checkbox" ng-checked="isSelected(item)" ng-click="toggleSelect(item)">
        </div>
        <div class="ratio ratio-1x1 bg-light overflow-hidden">
          <img ng-if="item.url" ng-src="{{item.url}}" alt="{{item.name}}" class="w-100 h-100"
            style="object-fit: cover;">
          <div ng-if="!item.url" class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
            <i class="bi bi-image fs-1 mb-2"></i>
            <span>No preview</span>
          </div>
        </div>
        <div class="card-body d-flex flex-column">
          <h6 class="text-truncate mb-1" title="{{item.name || item.key}}">
            {{item.name || item.key}}
          </h6>
          <p class="text-muted small mb-2">
            {{item.key}} · {{formatSize(item.size)}}
          </p>
          <div class="mt-auto d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-primary" ng-click="copyUrl(item.url)" ng-disabled="!item.url">
              Copy URL
            </button>
            <button class="btn btn-sm btn-outline-danger" ng-click="deleteImage(item)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center py-5" ng-if="!isLoading && images.length === 0">
    <i class="bi bi-images fs-1 text-muted d-block mb-2"></i>
    <p class="text-muted mb-0">Chưa có ảnh nào. Hãy tải ảnh lên để bắt đầu xây dựng thư viện.</p>
  </div>
</app-layout>
